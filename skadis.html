<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SK√ÖDIS Planer v10.2</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; height: 100vh; display: flex; overflow: hidden; background: #e0e0e0; 
            overscroll-behavior: none; user-select: none; -webkit-user-select: none;
        }
        
        /* --- SIDEBAR --- */
        .sidebar { 
            width: 350px; background: white; padding: 20px; display: flex; flex-direction: column; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 200; overflow-y: auto;
            position: absolute; height: 100%; left: 0; top: 0; 
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .sidebar.open { transform: translateX(0); }
        
        @media (min-width: 1024px) {
            .sidebar { position: relative; transform: none; width: 380px; }
            .sidebar-toggle { display: none !important; }
        }

        .sidebar-toggle { 
            position: absolute; top: 15px; left: 15px; z-index: 300; 
            background: #0058a3; color: white; border: none; 
            width: 44px; height: 44px; border-radius: 50%; 
            font-size: 1.5rem; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
        }

        h2 { color: #0058a3; margin-top: 0; font-size: 1.2rem; border-bottom: 2px solid #ffdb00; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
        
        .header-buttons { display: flex; gap: 8px; align-items: center; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0; color: #333; opacity: 0.7; transition: opacity 0.2s; }
        .icon-btn:hover { opacity: 1; }
        .lang-btn { font-size: 1.4rem; }
        
        .control-group { margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: #333; }
        
        input, select { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        button.btn-full { width: 100%; padding: 12px; border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 6px; margin-bottom: 8px; font-size: 0.95rem; }
        
        .btn-blue { background: #0058a3; } .btn-blue:active { background: #004f93; transform: scale(0.98); }
        .btn-dark { background: #333; } .btn-dark:active { background: #555; transform: scale(0.98); }
        .btn-green { background: #008a00; } 
        .btn-orange { background: #d68300; } 
        .btn-red { background: #cc0000; }
        .btn-group { display: flex; gap: 8px; margin-top: 5px; }
        
        .price-tag { font-size: 1.5rem; color: #0058a3; font-weight: bold; text-align: right; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc; }
        .flex-row { display: flex; gap: 10px; }
        .flex-col { flex: 1; display: flex; flex-direction: column; }
        .flex-col small { font-size: 0.75rem; color: #666; margin-bottom: 4px; }

        /* --- WORKSPACE --- */
        .workspace { 
            flex-grow: 1; overflow: hidden; position: relative; background-color: #d4d4d4; 
            touch-action: none; 
        }
        
        #zoomContainer { transform-origin: 0 0; position: absolute; top: 50%; left: 50%; transition: transform 0.1s linear; }
        #wall { background-color: #e5e5e5; border: 4px solid #444; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: translate(-50%, -50%); }
        .grid-on { background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px); background-size: 10px 10px; }
        
        /* --- ITEMS --- */
        .item { 
            position: absolute; box-sizing: border-box; 
            user-select: none; -webkit-user-select: none; 
            touch-action: none; cursor: grab;
        }
        .item.selected { border: 2px solid #ff0000 !important; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); z-index: 9999 !important; }

        .item.board { z-index: 10; border: 1px solid #999; border-radius: 12px; overflow: hidden; }
        .board-white { background-color: #ffffff; }
        .board-wood { background-color: #e3cbb3; border-color: #cbb092 !important; }
        .board-black { background-color: #333333; border-color: #111 !important; }

        .sim-hole { position: absolute; width: 2.5px; height: 7.5px; border-radius: 1.25px; background-color: rgba(0,0,0,0.18); transform: translate(-50%, -50%); pointer-events: none; }
        .board-black .sim-hole { background-color: rgba(255,255,255,0.25); }
        
        .mount-point { position: absolute; width: 14px; height: 14px; background: rgba(255, 0, 0, 0.1); border: 1.5px solid red; border-radius: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; z-index: 15; pointer-events: none; }
        .mount-point::after { content: "√ó"; color: red; font-weight: bold; font-size: 12px; line-height: 0; }

        .item.accessory { z-index: 50; border: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border-radius: 4px; overflow: hidden; padding: 2px; line-height: 1.1; font-weight: bold; }

        /* --- UI OVERLAYS --- */
        .overlay-controls { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
        .ctrl-btn { width: 44px; height: 44px; background: white; border: 1px solid #ccc; border-radius: 8px; font-size: 1.4rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: flex; justify-content: center; align-items: center; color: #333; cursor: pointer; }
        .ctrl-btn:hover { background: #f0f0f0; }
        
        .status-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); padding: 10px 15px; border-top: 1px solid #ccc; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 100; pointer-events: none; }

        #trash { position: fixed; bottom: 60px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #cc0000; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 30px; z-index: 150; transition: transform 0.2s, background 0.2s; }
        #trash.hover { transform: scale(1.2); background: #ff3333; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; }
        
        .settings-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 5px; margin-bottom: 5px; align-items: center; }
        .settings-row input { padding: 5px; font-size: 0.8rem; margin: 0; }
        .settings-header { font-weight: bold; font-size: 0.8rem; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

<button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>

<div class="sidebar" id="sidebar">
    <h2>
        <span data-i18n="title">SK√ÖDIS Planer</span>
        <div class="header-buttons">
            <button onclick="setLanguage('de')" class="icon-btn lang-btn" title="Deutsch">üá©üá™</button>
            <button onclick="setLanguage('en')" class="icon-btn lang-btn" title="English">üá¨üáß</button>
            <button onclick="openSettings()" class="icon-btn" title="Settings">‚öôÔ∏è</button>
            <button onclick="toggleSidebar()" class="icon-btn close-sidebar-btn">√ó</button>
        </div>
    </h2>
    
    <div class="control-group">
        <label data-i18n="lbl_project">Projekt</label>
        <div class="btn-group">
            <button class="btn-full btn-orange" onclick="exportJSON()">üíæ <span data-i18n="btn_save">Speichern</span></button>
            <button class="btn-full btn-orange" onclick="document.getElementById('fileInput').click()">üìÇ <span data-i18n="btn_load">Laden</span></button>
        </div>
        <input type="file" id="fileInput" style="display:none" onchange="importJSON(this)" accept=".json">
        <button class="btn-full btn-green" onclick="exportPrint()">üñ®Ô∏è <span data-i18n="btn_print">PDF / Drucken</span></button>
        <div style="margin-top:10px; display:flex; align-items:center; gap:10px;">
            <input type="checkbox" id="gridCheck" checked onchange="toggleGrid()" style="width:auto; margin:0; height:20px; width:20px;"> 
            <label for="gridCheck" style="margin:0;" data-i18n="lbl_grid">2cm Raster</label>
        </div>
    </div>

    <div class="control-group">
        <label data-i18n="lbl_wall">1. Wandgr√∂√üe (cm)</label>
        <div class="flex-row">
            <div class="flex-col"><small data-i18n="lbl_width">Breite</small><input type="number" id="wallW" value="100" onchange="resizeWall()"></div>
            <div class="flex-col"><small data-i18n="lbl_height">H√∂he</small><input type="number" id="wallH" value="150" onchange="resizeWall()"></div>
        </div>
    </div>

    <div class="control-group">
        <label data-i18n="lbl_board">2. Platte hinzuf√ºgen</label>
        <small style="display:block; margin-bottom:5px; color:#666;" data-i18n="lbl_board_tip">Tippen um auf die Wand zu werfen</small>
        <div class="flex-row">
            <select id="boardSel" style="flex-grow:2;">
                </select>
            <select id="boardColor" style="flex-grow:1;">
                <option value="white" data-i18n="color_white">Wei√ü</option>
                <option value="wood" data-i18n="color_wood">Holz</option>
                <option value="black" data-i18n="color_black">Schwarz</option>
            </select>
        </div>
        <button class="btn-full btn-blue" onclick="spawnBoard()">‚ûï <span data-i18n="btn_add_board">Platte auf Wand werfen</span></button>
    </div>

    <div class="control-group">
        <label data-i18n="lbl_acc">3. Zubeh√∂r hinzuf√ºgen</label>
        <select id="accType" onchange="toggleCustomInput()">
            </select>

        <div id="customInputs" style="display:none; margin-top:10px; border-top:1px solid #ddd; padding-top:10px;">
            <div class="flex-row">
                <div class="flex-col"><small data-i18n="lbl_width">Breite</small><input type="number" id="custW" value="10"></div>
                <div class="flex-col"><small data-i18n="lbl_height">H√∂he</small><input type="number" id="custH" value="10"></div>
            </div>
            <input type="text" id="custName" placeholder="Name" style="margin-top:5px;">
            <div class="flex-row">
                <input type="color" id="custColor" value="#ff8800" style="height:40px;">
                <input type="number" id="custPrice" value="0.50" step="0.10">
            </div>
        </div>

        <button class="btn-full btn-dark" onclick="spawnAccessory()">‚ûï <span data-i18n="btn_add_acc">Teil auf Wand werfen</span></button>
    </div>

    <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
        <button class="btn-full btn-dark" onclick="clearWall()" style="background:#555; font-size:0.8rem;">‚ö†Ô∏è <span data-i18n="btn_reset">Alles l√∂schen / Reset</span></button>
    </div>

    <div class="price-tag" id="totalPrice">‚Ç¨0.00</div>
    <div style="height: 50px;"></div>
</div>

<div class="workspace" id="workspace">
    <div id="zoomContainer"><div id="wall" class="grid-on"></div></div>
    <div class="overlay-controls">
        <button class="ctrl-btn" onclick="undo()" title="R√ºckg√§ngig (Strg+Z)">‚Ü©Ô∏è</button>
        <button class="ctrl-btn" onclick="duplicateSelected()" title="Duplizieren (Strg+D)">üìÑ</button>
        <button class="ctrl-btn" onclick="changeZoom(0.1)" title="Zoom In">‚ûï</button>
        <button class="ctrl-btn" onclick="changeZoom(-0.1)" title="Zoom Out">‚ûñ</button>
        <button class="ctrl-btn" onclick="resetView()" title="Zentrieren">‚ü≤</button>
    </div>
    <div id="trash" title="üóëÔ∏è">üóëÔ∏è</div>
    <div class="status-bar">
        <div id="statusText" data-i18n="status_text">Doppeltipp = Edit | Ziehen auf üóëÔ∏è = L√∂schen</div>
        <div><span id="coords">x: -, y: -</span></div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top:0;" data-i18n="modal_edit">Bearbeiten</h3>
        <label data-i18n="lbl_name">Name:</label>
        <input type="text" id="editName">
        <label data-i18n="lbl_color">Farbe:</label>
        <input type="color" id="editColor" style="height:50px; margin-bottom: 10px;">
        
        <div class="flex-row" style="margin-bottom: 15px;">
            <div class="flex-col">
                <label data-i18n="lbl_width" style="margin-bottom:2px;">Breite (cm):</label>
                <input type="number" id="editW" step="1" min="1">
            </div>
            <div class="flex-col">
                <label data-i18n="lbl_height" style="margin-bottom:2px;">H√∂he (cm):</label>
                <input type="number" id="editH" step="1" min="1">
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-full btn-blue" onclick="saveEdit()" data-i18n="btn_save_only">Speichern</button>
            <button class="btn-full btn-dark" onclick="closeEdit()" data-i18n="btn_cancel">Abbrechen</button>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <h3 style="margin-top:0;" data-i18n="modal_settings">Einstellungen (Preise & Ma√üe)</h3>
        
        <div class="settings-row settings-header">
            <div>Name</div><div>‚Ç¨ Preis</div><div>B (cm)</div><div>H (cm)</div>
        </div>
        <div id="settingsList"></div>
        
        <div class="btn-group" style="margin-top: 15px;">
            <button class="btn-full btn-blue" onclick="saveSettings()" data-i18n="btn_save_only">Speichern</button>
            <button class="btn-full btn-dark" onclick="closeSettings()" data-i18n="btn_cancel">Abbrechen</button>
        </div>
    </div>
</div>

<script>
    // --- APP DATA & I18N ---
    const i18n = {
        de: {
            title: "SK√ÖDIS Planer", lbl_project: "Projekt", btn_save: "Speichern", btn_load: "Laden", btn_print: "PDF / Drucken",
            lbl_grid: "2cm Raster", lbl_wall: "1. Wandgr√∂√üe (cm)", lbl_width: "Breite", lbl_height: "H√∂he", 
            lbl_board: "2. Platte hinzuf√ºgen", lbl_board_tip: "Tippen um auf die Wand zu werfen", 
            color_white: "Wei√ü", color_wood: "Holz", color_black: "Schwarz", btn_add_board: "Platte auf Wand werfen",
            lbl_acc: "3. Zubeh√∂r hinzuf√ºgen", btn_add_acc: "Teil auf Wand werfen", btn_reset: "Alles l√∂schen / Reset",
            status_text: "Doppeltipp = Edit | Ziehen auf üóëÔ∏è = L√∂schen", modal_edit: "Bearbeiten", lbl_name: "Name:", lbl_color: "Farbe:",
            btn_save_only: "Speichern", btn_cancel: "Abbrechen", modal_settings: "Einstellungen (Preise & Ma√üe)",
            grp_container: "Beh√§lter & Aufbewahrung", grp_hooks: "Haken", grp_special: "Spezialhalter", grp_custom: "Montage & Custom",
            opt_custom: "-- Manuelles Teil (3D Druck) --", alert_reset: "Alles l√∂schen?"
        },
        en: {
            title: "SK√ÖDIS Planner", lbl_project: "Project", btn_save: "Save", btn_load: "Load", btn_print: "PDF / Print",
            lbl_grid: "2cm Grid", lbl_wall: "1. Wall Size (cm)", lbl_width: "Width", lbl_height: "Height", 
            lbl_board: "2. Add Pegboard", lbl_board_tip: "Tap to place on wall", 
            color_white: "White", color_wood: "Wood", color_black: "Black", btn_add_board: "Throw board on wall",
            lbl_acc: "3. Add Accessories", btn_add_acc: "Throw item on wall", btn_reset: "Delete All / Reset",
            status_text: "Double Tap = Edit | Drag to üóëÔ∏è = Delete", modal_edit: "Edit Item", lbl_name: "Name:", lbl_color: "Color:",
            btn_save_only: "Save", btn_cancel: "Cancel", modal_settings: "Settings (Prices & Dimensions)",
            grp_container: "Containers & Storage", grp_hooks: "Hooks", grp_special: "Special Holders", grp_custom: "Mounts & Custom",
            opt_custom: "-- Custom Part (3D Print) --", alert_reset: "Delete everything?"
        }
    };

    let userLang = localStorage.getItem('skadis_lang') || (navigator.language.startsWith('de') ? 'de' : 'en');

    function setLanguage(lang) {
        userLang = lang;
        localStorage.setItem('skadis_lang', lang);
        applyLanguage();
    }

    let appConfig = {
        boards: [
            { id: "b1", w: 36, h: 56, price: 9.99, name: "36x56 cm" },
            { id: "b2", w: 56, h: 56, price: 14.99, name: "56x56 cm" },
            { id: "b3", w: 76, h: 56, price: 17.99, name: "76x56 cm" }
        ],
        accessories: [
            { id: "a1", grp: "grp_container", de: "Beh√§lter", en: "Container", price: 3.00, w: 11, h: 11 },
            { id: "a2", grp: "grp_container", de: "Beh√§lter m. Deckel 3er", en: "Container w/ Lids (3pk)", price: 10.00, w: 11, h: 24 },
            { id: "a3", grp: "grp_container", de: "Ablage", en: "Shelf", price: 4.00, w: 27, h: 6 },
            { id: "a4", grp: "grp_container", de: "Beutel", en: "Bag", price: 5.00, w: 20, h: 25 },
            
            { id: "a5", grp: "grp_hooks", de: "Haken kurz", en: "Short Hook", price: 3.00, w: 4, h: 6 },
            { id: "a6", grp: "grp_hooks", de: "Haken lang", en: "Long Hook", price: 3.00, w: 4, h: 10 },
            { id: "a7", grp: "grp_hooks", de: "Haken J-Form", en: "J-Hook", price: 3.00, w: 4, h: 8 },
            
            { id: "a8", grp: "grp_special", de: "Rollenhalter", en: "Roll Holder", price: 3.00, w: 28, h: 10 },
            { id: "a9", grp: "grp_special", de: "Werkzeughalter", en: "Tool Holder", price: 2.00, w: 19, h: 4 },
            { id: "a10", grp: "grp_special", de: "Halter Zange/Schere", en: "Pliers/Scissors Holder", price: 3.00, w: 4, h: 6 },
            { id: "a11", grp: "grp_special", de: "Klemme 2er", en: "Clips (2pk)", price: 3.00, w: 4, h: 4 },
            
            { id: "a12", grp: "grp_custom", de: "Befestigungsbeschlag", en: "Mounting Hardware", price: 5.00, w: 4, h: 10 }
        ]
    };

    function applyLanguage() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (i18n[userLang][key]) el.innerText = i18n[userLang][key];
        });
        buildDropdowns();
    }

    function buildDropdowns() {
        const boardSel = document.getElementById('boardSel');
        boardSel.innerHTML = "";
        appConfig.boards.forEach(b => {
            let opt = document.createElement('option');
            opt.value = b.price; opt.dataset.w = b.w; opt.dataset.h = b.h; opt.dataset.id = b.id;
            opt.innerText = `${b.name} (‚Ç¨${b.price.toFixed(2)})`;
            boardSel.appendChild(opt);
        });

        const accSel = document.getElementById('accType');
        accSel.innerHTML = "";
        let currentGrp = ""; let optGroup = null;
        
        appConfig.accessories.forEach(a => {
            if (a.grp !== currentGrp) {
                currentGrp = a.grp;
                optGroup = document.createElement('optgroup');
                optGroup.label = i18n[userLang][currentGrp] || currentGrp;
                accSel.appendChild(optGroup);
            }
            let opt = document.createElement('option');
            opt.value = "std";
            opt.dataset.id = a.id;
            opt.dataset.price = a.price; opt.dataset.w = a.w; opt.dataset.h = a.h;
            opt.innerText = `${a[userLang]} (‚Ç¨${a.price.toFixed(2)})`;
            optGroup.appendChild(opt);
        });

        let custGrp = document.createElement('optgroup');
        custGrp.label = i18n[userLang].grp_custom;
        let custOpt = document.createElement('option');
        custOpt.value = "custom";
        custOpt.innerText = i18n[userLang].opt_custom;
        custGrp.appendChild(custOpt);
        accSel.appendChild(custGrp);
    }

    // --- SYSTEM LOGIC ---
    const scale = 5; 
    const workspace = document.getElementById('workspace');
    const wallDiv = document.getElementById('wall');
    const zoomContainer = document.getElementById('zoomContainer');
    const coordsSpan = document.getElementById('coords');
    const sidebar = document.getElementById('sidebar');
    const trash = document.getElementById('trash');

    let currentZoom = 0.8; 
    let panX = 0, panY = 0;
    let isPanning = false, startPanX = 0, startPanY = 0, lastPinchDist = null, initialZoom = 1;
    let selectedItem = null, isDraggingItem = false, dragItem = null, dragOffsetX = 0, dragOffsetY = 0;
    
    // Undo-System
    let historyStack = [];
    let pendingState = null;
    let dragStartX = null, dragStartY = null;

    function saveState() {
        historyStack.push(wallDiv.innerHTML);
        if(historyStack.length > 20) historyStack.shift();
    }

    function undo() {
        if(historyStack.length === 0) return;
        wallDiv.innerHTML = historyStack.pop();
        
        // Event-Listener nach Wiederherstellung neu binden
        Array.from(wallDiv.children).forEach(el => {
            if(el.classList.contains('item')) {
                el.addEventListener('dblclick', () => openEdit(el));
            }
        });
        
        deselectItem();
        stopDragItem();
        updatePrice();
    }

    function duplicateSelected() {
        if (!selectedItem) return;
        saveState();
        
        const clone = selectedItem.cloneNode(true);
        let curLeft = parseFloat(clone.style.left) || 0;
        let curTop = parseFloat(clone.style.top) || 0;
        
        // Leicht versetzt einf√ºgen
        clone.style.left = (curLeft + 15) + 'px';
        clone.style.top = (curTop + 15) + 'px';
        
        clone.classList.remove('selected');
        clone.addEventListener('dblclick', () => openEdit(clone));
        
        wallDiv.appendChild(clone);
        selectItem(clone);
        updatePrice();
    }

    applyLanguage();
    resizeWall();
    centerWall();

    function toggleSidebar() { sidebar.classList.toggle('open'); }

    function updateTransform() { zoomContainer.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`; }
    function changeZoom(delta) { currentZoom = Math.min(Math.max(currentZoom + delta, 0.2), 3.0); updateTransform(); }
    function resetView() { centerWall(); }
    function centerWall() { panX = 0; panY = 0; currentZoom = window.innerWidth < 600 ? 0.5 : 0.8; updateTransform(); }

    workspace.addEventListener('touchstart', handleTouchStart, {passive: false});
    workspace.addEventListener('touchmove', handleTouchMove, {passive: false});
    workspace.addEventListener('touchend', handleTouchEnd);
    workspace.addEventListener('mousedown', handleMouseDown);
    window.addEventListener('mousemove', handleMouseMove);
    window.addEventListener('mouseup', handleMouseUp);
    workspace.addEventListener('wheel', (e) => { e.preventDefault(); changeZoom(-Math.sign(e.deltaY)*0.1); }, {passive:false});

    function handleTouchStart(e) {
        const item = e.target.closest('.item');
        if (item && e.touches.length === 1) {
            e.stopPropagation(); e.preventDefault(); selectItem(item);
            const now = new Date().getTime(), last = item.dataset.lastTap || 0;
            if (now - last < 300) { openEdit(item); return; }
            item.dataset.lastTap = now;
            startDragItem(item, e.touches[0].clientX, e.touches[0].clientY); return;
        }
        if (e.touches.length === 2) { isPanning = false; lastPinchDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); initialZoom = currentZoom; } 
        else if (e.touches.length === 1) { if(selectedItem) deselectItem(); isPanning = true; startPanX = e.touches[0].clientX - panX; startPanY = e.touches[0].clientY - panY; }
    }
    function handleTouchMove(e) {
        if (isDraggingItem && dragItem) { e.preventDefault(); moveDragItem(e.touches[0].clientX, e.touches[0].clientY); checkTrashHover(e.touches[0].clientX, e.touches[0].clientY); }
        else if (e.touches.length === 2 && lastPinchDist) { e.preventDefault(); const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); currentZoom = Math.min(Math.max(initialZoom + (dist - lastPinchDist) * 0.005, 0.2), 3.0); updateTransform(); } 
        else if (isPanning) { e.preventDefault(); panX = e.touches[0].clientX - startPanX; panY = e.touches[0].clientY - startPanY; updateTransform(); }
    }
    function handleTouchEnd(e) { 
        if(isDraggingItem && dragItem && trash.classList.contains('hover')) deleteSelected();
        trash.classList.remove('hover'); isPanning = false; lastPinchDist = null; stopDragItem(); 
    }
    function handleMouseDown(e) {
        const item = e.target.closest('.item');
        if (item) { e.stopPropagation(); selectItem(item); startDragItem(item, e.clientX, e.clientY); }
        else { deselectItem(); isPanning = true; startPanX = e.clientX - panX; startPanY = e.clientY - panY; workspace.style.cursor = 'grabbing'; }
    }
    function handleMouseMove(e) {
        if (isDraggingItem) { e.preventDefault(); moveDragItem(e.clientX, e.clientY); checkTrashHover(e.clientX, e.clientY); }
        else if (isPanning) { e.preventDefault(); panX = e.clientX - startPanX; panY = e.clientY - startPanY; updateTransform(); }
    }
    function handleMouseUp(e) { 
        if(isDraggingItem && trash.classList.contains('hover')) deleteSelected();
        trash.classList.remove('hover'); isPanning = false; workspace.style.cursor = 'default'; stopDragItem(); 
    }

    function startDragItem(item, cx, cy) { 
        pendingState = wallDiv.innerHTML; 
        dragStartX = item.style.left; dragStartY = item.style.top;
        isDraggingItem = true; dragItem = item; dragItem.style.opacity = '0.6'; 
        const rect = dragItem.getBoundingClientRect(); dragOffsetX = cx - rect.left; dragOffsetY = cy - rect.top; 
    }
    
    function moveDragItem(cx, cy) {
        if (!dragItem) return;
        const wallRect = wallDiv.getBoundingClientRect();
        let x = (cx - wallRect.left - dragOffsetX) / currentZoom; let y = (cy - wallRect.top - dragOffsetY) / currentZoom;
        x = Math.round(x / 5) * 5; y = Math.round(y / 5) * 5;
        dragItem.style.left = x + 'px'; dragItem.style.top = y + 'px'; updateCoordsDisplay();
    }
    
    function stopDragItem() { 
        if (dragItem) {
            dragItem.style.opacity = '1'; 
            if (pendingState && (dragStartX !== dragItem.style.left || dragStartY !== dragItem.style.top)) {
                historyStack.push(pendingState);
                if(historyStack.length > 20) historyStack.shift();
            }
        }
        isDraggingItem = false; dragItem = null; pendingState = null;
    }
    
    function checkTrashHover(x, y) { const tRect = trash.getBoundingClientRect(); if (x >= tRect.left && x <= tRect.right && y >= tRect.top && y <= tRect.bottom) trash.classList.add('hover'); else trash.classList.remove('hover'); }

    function selectItem(el) { if (selectedItem) selectedItem.classList.remove('selected'); selectedItem = el; selectedItem.classList.add('selected'); updateCoordsDisplay(); }
    function deselectItem() { if (selectedItem) selectedItem.classList.remove('selected'); selectedItem = null; coordsSpan.innerText = "x: -, y: -"; }
    
    function deleteSelected() { 
        if (selectedItem) { 
            saveState();
            selectedItem.remove(); 
            deselectItem(); 
            updatePrice(); 
            trash.classList.remove('hover'); 
        } 
    }

    document.addEventListener('keydown', (e) => {
        // Tastenk√ºrzel f√ºr Undo und Duplizieren
        if (e.ctrlKey || e.metaKey) {
            if (e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); return; }
            if (e.key.toLowerCase() === 'd') { e.preventDefault(); duplicateSelected(); return; }
        }

        if (e.target.tagName === 'INPUT') return;
        if (!selectedItem) return;
        
        const step = e.shiftKey ? 20 : 5; 
        let l = parseInt(selectedItem.style.left); let t = parseInt(selectedItem.style.top); let moved = false;
        
        if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
            if (!e.repeat) saveState();
        }

        switch(e.key) {
            case 'Delete': case 'Backspace': deleteSelected(); return;
            case 'ArrowLeft': selectedItem.style.left = (l - step) + 'px'; moved = true; break;
            case 'ArrowRight': selectedItem.style.left = (l + step) + 'px'; moved = true; break;
            case 'ArrowUp': selectedItem.style.top = (t - step) + 'px'; moved = true; break;
            case 'ArrowDown': selectedItem.style.top = (t + step) + 'px'; moved = true; break;
        }
        if(moved) { e.preventDefault(); updateCoordsDisplay(); }
    });

    function spawnItemOnWall(data) {
        saveState();
        const el = document.createElement('div'); el.className = 'item ' + data.type;
        el.style.width = (data.w * scale) + 'px'; el.style.height = (data.h * scale) + 'px';
        if (data.type === 'board') {
            el.classList.add('board-' + (data.variant || 'white')); el.dataset.variant = data.variant;
            generateHoles(el, data.w, data.h);
        } else {
            const color = data.color || "#0058a3"; el.style.backgroundColor = color;
            el.style.borderColor = adjustColor(color, -40); el.style.color = getContrastColor(color);
            el.style.fontSize = Math.max(10, Math.min(16, Math.min(data.w, data.h)*scale/4))+'px';
            el.innerHTML = `<span>${data.name}</span>`;
        }
        el.dataset.name = data.name; el.dataset.price = data.price; el.dataset.type = data.datasetType;
        if(data.isCustom) { el.dataset.color = data.color; }
        const wallW = parseFloat(wallDiv.style.width), wallH = parseFloat(wallDiv.style.height);
        el.style.left = (wallW/2 - (data.w*scale)/2) + 'px'; el.style.top = (wallH/2 - (data.h*scale)/2) + 'px';
        el.addEventListener('dblclick', () => openEdit(el));
        wallDiv.appendChild(el); selectItem(el); updatePrice();
    }

    function spawnBoard() {
        const sel = document.getElementById('boardSel'), opt = sel.options[sel.selectedIndex];
        spawnItemOnWall({ type: 'board', price: parseFloat(sel.value), w: parseInt(opt.dataset.w), h: parseInt(opt.dataset.h), name: 'Board', variant: document.getElementById('boardColor').value, datasetType: 'ikea' });
    }
    function spawnAccessory() {
        const type = document.getElementById('accType').value;
        let data = { type: 'accessory' };
        if (type === 'custom') {
            data.isCustom = true; data.name = document.getElementById('custName').value || "Teil"; data.datasetType = 'custom';
            data.w = parseFloat(document.getElementById('custW').value)||10; data.h = parseFloat(document.getElementById('custH').value)||10;
            data.price = parseFloat(document.getElementById('custPrice').value)||0; data.color = document.getElementById('custColor').value;
        } else {
            const sel = document.getElementById('accType'), opt = sel.options[sel.selectedIndex];
            data.name = opt.text.split(' (')[0]; data.price = parseFloat(opt.dataset.price);
            data.w = parseFloat(opt.dataset.w); data.h = parseFloat(opt.dataset.h);
            data.datasetType = 'ikea';
        }
        spawnItemOnWall(data);
    }

    function updatePrice(){ let t=0; document.querySelectorAll('.item').forEach(el=>t+=parseFloat(el.dataset.price||0)); document.getElementById('totalPrice').innerText='‚Ç¨'+t.toFixed(2); }
    function toggleCustomInput() { document.getElementById('customInputs').style.display = (document.getElementById('accType').value === 'custom') ? 'block' : 'none'; }
    function resizeWall() { wallDiv.style.width = (document.getElementById('wallW').value * scale) + 'px'; wallDiv.style.height = (document.getElementById('wallH').value * scale) + 'px'; }
    function toggleGrid() { wallDiv.classList.toggle('grid-on', document.getElementById('gridCheck').checked); }
    function clearWall() { if(confirm(i18n[userLang].alert_reset)) { saveState(); wallDiv.innerHTML = ''; updatePrice(); deselectItem(); } }
    function updateCoordsDisplay() { if(selectedItem) coordsSpan.innerText = `Pos: ${Math.round(parseInt(selectedItem.style.left)/scale)}/${Math.round(parseInt(selectedItem.style.top)/scale)} cm`; }
    function getContrastColor(hex){if(!hex||!hex.startsWith('#'))return'white';const r=parseInt(hex.substr(1,2),16),g=parseInt(hex.substr(3,2),16),b=parseInt(hex.substr(5,2),16);return((r*299)+(g*587)+(b*114))/1000>=128?'black':'white';}
    function adjustColor(c,a){if(!c||!c.startsWith('#'))return'#000';return'#'+c.replace(/^#/, '').replace(/../g,c=>('0'+Math.min(255,Math.max(0,parseInt(c,16)+a)).toString(16)).substr(-2));}
    
    function generateHoles(el,w,h){
        for(let r=0;r<27;r++){
            const xStart=(r%2===0)?4:2;
            for(let x=xStart;x<=w-2;x+=4){
                const d=document.createElement('div');d.className='sim-hole';d.style.left=(x*scale)+'px';d.style.top=(2+(r*2))*scale+'px';el.appendChild(d);
                if (r === 0 || r === 26) {
                    if (x === xStart || (x + 4 > w - 2)) {
                        const mp = document.createElement('div'); mp.className = 'mount-point';
                        mp.style.left = (x * scale) + 'px'; mp.style.top = (2+(r*2))*scale + 'px'; el.appendChild(mp);
                    }
                }
            }
        }
    }

    // --- ITEM EDITOR ---
    let editTarget = null;
    function openEdit(el) { 
        if(!el) return; editTarget = el; 
        document.getElementById('editName').value = editTarget.dataset.name; 
        document.getElementById('editColor').value = editTarget.dataset.color || "#0058a3"; 
        
        // Lade aktuelle Ma√üe in die Inputs
        document.getElementById('editW').value = parseFloat(editTarget.style.width) / scale;
        document.getElementById('editH').value = parseFloat(editTarget.style.height) / scale;

        document.getElementById('editModal').style.display = 'flex'; 
    }
    
    function saveEdit() { 
        if(editTarget) {
            saveState(); // Vor √Ñnderung speichern f√ºr Undo
            
            editTarget.dataset.name = document.getElementById('editName').value;
            
            // Neue Ma√üe anwenden
            const newW = parseFloat(document.getElementById('editW').value) || 10;
            const newH = parseFloat(document.getElementById('editH').value) || 10;
            
            editTarget.style.width = (newW * scale) + 'px';
            editTarget.style.height = (newH * scale) + 'px';

            if(editTarget.classList.contains('board')) {
                // Bei Boards L√∂cher neu generieren
                editTarget.querySelectorAll('.sim-hole, .mount-point').forEach(e => e.remove());
                generateHoles(editTarget, newW, newH);
            } else if(editTarget.classList.contains('accessory')) {
                const c = document.getElementById('editColor').value;
                editTarget.style.backgroundColor = c; editTarget.dataset.color = c; editTarget.style.borderColor = adjustColor(c,-40);
                editTarget.style.color = getContrastColor(c); 
                editTarget.querySelector('span').innerText = editTarget.dataset.name;
                // Schriftgr√∂√üe an neue Box anpassen
                editTarget.style.fontSize = Math.max(10, Math.min(16, Math.min(newW, newH)*scale/4))+'px';
            }
        }
        closeEdit();
        updateCoordsDisplay();
    }
    
    function closeEdit(){ document.getElementById('editModal').style.display='none'; editTarget=null; }

    // --- GLOBAL SETTINGS (Ma√üe & Preise) ---
    function openSettings() {
        const list = document.getElementById('settingsList');
        list.innerHTML = "";
        
        appConfig.accessories.forEach(a => {
            let row = document.createElement('div');
            row.className = "settings-row";
            row.innerHTML = `
                <div style="font-size:0.8rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${a[userLang]}">${a[userLang]}</div>
                <input type="number" id="set_p_${a.id}" value="${a.price}" step="0.1">
                <input type="number" id="set_w_${a.id}" value="${a.w}">
                <input type="number" id="set_h_${a.id}" value="${a.h}">
            `;
            list.appendChild(row);
        });
        document.getElementById('settingsModal').style.display = 'flex';
    }

    function saveSettings() {
        appConfig.accessories.forEach(a => {
            a.price = parseFloat(document.getElementById(`set_p_${a.id}`).value) || 0;
            a.w = parseFloat(document.getElementById(`set_w_${a.id}`).value) || 1;
            a.h = parseFloat(document.getElementById(`set_h_${a.id}`).value) || 1;
        });
        buildDropdowns(); 
        closeSettings();
    }

    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }

    // --- IMPORT / EXPORT ---
    function exportJSON() {
        const config = { wallW: document.getElementById('wallW').value, wallH: document.getElementById('wallH').value, items: [] };
        Array.from(wallDiv.children).forEach(el => config.items.push({ className: el.className, l: el.style.left, t: el.style.top, w: el.style.width, h: el.style.height, ds: Object.assign({}, el.dataset), bg: el.style.backgroundColor }));
        const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config)); a.download = "skadis.json"; a.click();
    }
    function importJSON(input) {
        if(!input.files[0]) return;
        const r = new FileReader();
        r.onload = function(e) {
            try {
                saveState();
                const c = JSON.parse(e.target.result);
                document.getElementById('wallW').value = c.wallW; document.getElementById('wallH').value = c.wallH; resizeWall();
                wallDiv.innerHTML = '';
                c.items.forEach(i => {
                    spawnItemOnWall({ type: i.className.includes('board')?'board':'accessory', price: parseFloat(i.ds.price), w: parseInt(i.w)/scale, h: parseInt(i.h)/scale, name: i.ds.name, variant: i.ds.variant, color: i.bg, isCustom: (i.ds.type==='custom'), datasetType: i.ds.type });
                    wallDiv.lastChild.style.left = i.l; wallDiv.lastChild.style.top = i.t;
                });
                updatePrice();
            } catch (err) { alert("Error"); }
        };
        r.readAsText(input.files[0]); input.value = '';
    }
    function exportPrint() { window.print(); }
</script>
</body>
</html>
